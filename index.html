<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Student Portal & Admin Manager</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none !important; } 
        .active-tab { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #e0e7ff; }
        .inactive-tab { color: #6b7280; }
        
        /* Custom borders for dashboard cards */
        .card-border-blue { border-left: 5px solid #3b82f6; }
        .card-border-green { border-left: 5px solid #10b981; }
        .card-border-red { border-left: 5px solid #ef4444; }
        .card-border-orange { border-left: 5px solid #f97316; }

        /* Smooth transitions */
        .transition-all { transition: all 0.3s ease; }
        
        /* Accordion Animation */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-item.active .accordion-content { max-height: 800px; }
        .accordion-button { transition: transform 0.3s; }
        .accordion-item.active .accordion-button { transform: rotate(90deg); }

        /* Map styling */
        #map { height: 400px; width: 100%; border-radius: 0.5rem; z-index: 1; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script> 
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body class="bg-gray-100 font-sans p-4 min-h-screen flex flex-col items-center text-gray-800">

    <div class="w-full max-w-6xl bg-white p-8 rounded-xl shadow-2xl mt-8 mb-10 relative overflow-hidden">
        
        <header class="flex justify-between items-center pb-4 border-b border-gray-200">
            <div class="flex items-center gap-2">
                <div class="text-3xl">üéì</div>
                <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700 tracking-tight">PCIU Portal</h1>
            </div>
            <button id="logoutBtn" onclick="logout()" style="display: none;" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                Logout
            </button>
        </header>

        <section id="login-section" class="mt-8">
            <div class="max-w-md mx-auto bg-gray-50 p-8 rounded-xl shadow-lg border border-gray-200">
                <div class="flex justify-center mb-4">
                    <lottie-player src="https://assets3.lottiefiles.com/packages/lf20_jcikwtux.json"  background="transparent"  speed="1"  style="width: 150px; height: 150px;"  loop  autoplay></lottie-player>
                </div>
                <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Secure Login</h2>
                <input type="email" id="loginEmail" placeholder="Email (admin@university.edu)" class="w-full p-3 mb-4 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200 transform hover:scale-105 shadow-md">
                    Sign In
                </button>
                <div id="login-error" class="mt-4 text-center text-red-500 hidden font-medium bg-red-50 p-2 rounded border border-red-200"></div>
            </div>
        </section>

        <section id="admin-section" class="hidden mt-6" style="display: none;">
            <h2 class="text-3xl font-bold mb-4 text-indigo-700 flex items-center gap-2">
                <span>üèõÔ∏è</span> Admin Dashboard
            </h2>
            
            <div class="flex border-b border-gray-300 mb-6 flex-wrap gap-2">
                <button onclick="showAdminPanel('dashboard-panel')" id="dashboard-tab" class="tab-btn px-4 py-2 font-medium rounded-t-lg active-tab">Dashboard</button>
                <button onclick="showAdminPanel('add-student-panel'); resetForm();" id="add-student-tab" class="tab-btn px-4 py-2 font-medium rounded-t-lg inactive-tab hover:bg-gray-50">Add/Edit Data</button>
                <button onclick="showAdminPanel('routine-panel')" id="routine-tab" class="tab-btn px-4 py-2 font-medium rounded-t-lg inactive-tab hover:bg-gray-50">Publish Routine</button>
                <button onclick="showAdminPanel('calendar-panel'); fetchAcademicCalendar();" id="calendar-tab" class="tab-btn px-4 py-2 font-medium rounded-t-lg inactive-tab hover:bg-gray-50">Calendar</button>
                <button onclick="showAdminPanel('publish-results-panel')" id="publish-results-tab" class="tab-btn px-4 py-2 font-medium rounded-t-lg inactive-tab hover:bg-gray-50">Results</button>
                <button onclick="showAdminPanel('feedback-panel'); fetchFeedback();" id="feedback-tab" class="tab-btn px-4 py-2 font-medium rounded-t-lg inactive-tab hover:bg-gray-50">Feedback</button>
            </div>

            <div id="dashboard-panel" class="panel-content">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow-md card-border-blue hover:shadow-lg transition">
                        <p class="text-gray-500 font-medium">Total Students</p>
                        <p id="dashboard-total-students" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md card-border-green hover:shadow-lg transition">
                        <p class="text-gray-500 font-medium">Active Enrollment</p>
                        <p id="dashboard-active-enrollment" class="text-3xl font-bold text-green-600 mt-1">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md card-border-red hover:shadow-lg transition">
                        <p class="text-gray-500 font-medium">Inactive/Dropout</p>
                        <p id="dashboard-inactive-dropout" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md card-border-orange hover:shadow-lg transition">
                        <p class="text-gray-500 font-medium">No. of Departments</p>
                        <p id="dashboard-department-count" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-xl border border-gray-200">
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                        <select id="department-filter" onchange="filterByDepartment()" class="w-full sm:w-1/3 p-3 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="All">All Departments</option>
                        </select>
                        <input type="text" id="search-input" placeholder="Search by name, ID, or phone..." oninput="searchStudents()" class="w-full sm:w-2/3 p-3 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="overflow-x-auto" style="min-height: 300px;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">CGPA</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center mt-4 border-t pt-4">
                        <span class="text-sm text-gray-600">Showing <span id="page-info-start">0</span> to <span id="page-info-end">0</span> of <span id="page-info-total">0</span> entries</span>
                        <div class="flex gap-2">
                            <button onclick="prevPage()" id="btn-prev" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 transition">Previous</button>
                            <button onclick="nextPage()" id="btn-next" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 disabled:opacity-50 transition">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="add-student-panel" class="panel-content hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 border-l-4 border-indigo-500 pl-3"><span id="form-title">Add Student Data</span></h3>
                <div class="bg-white p-6 rounded-lg shadow-xl border border-gray-200">
                    <form id="addStudentForm" class="space-y-4">
                        <input type="hidden" id="originalEmail" value="">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Student ID *</label>
                                <input type="text" id="sID" placeholder="e.g., CSE03108145" class="w-full p-3 border rounded focus:ring-2 focus:ring-indigo-400" required oninput="autoFillPassword(); checkUniqueId(this.value)">
                                <p id="id-error" class="text-xs text-red-500 hidden">ID already exists!</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date of Birth *</label>
                                <input type="date" id="sDOB" class="w-full p-3 border rounded focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone Number *</label>
                                <input type="tel" id="sPhone" placeholder="+880 1XXX-XXXXXX" class="w-full p-3 border rounded focus:ring-2 focus:ring-indigo-400" required onchange="validatePhone(this)">
                                <p id="phone-error" class="text-xs text-red-500 hidden">Invalid phone format.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email (Login) *</label>
                                <input type="email" id="sEmail" placeholder="student@university.edu" class="w-full p-3 border rounded focus:ring-2 focus:ring-indigo-400" required>
                            </div>
                        </div>
                        <input type="password" id="sPassword" placeholder="Temporary Password" class="w-full p-3 border rounded bg-gray-50" required>
                        <input type="text" id="sName" placeholder="Full Name" class="w-full p-3 border rounded" required>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Department</label>
                                <select id="sDept" onchange="updatePrograms()" class="w-full p-3 border rounded bg-white" required>
                                    <option value="">Select Department</option>
                                    <option value="Computer Science">Computer Science</option>
                                    <option value="Business Admin">Business Admin</option>
                                    <option value="Electrical Eng">Electrical Eng</option>
                                    <option value="LLB">LLB</option>
                                    <option value="CEN">CEN</option>
                                    <option value="ENG">ENG</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Program/Major</label>
                                <select id="sProgram" class="w-full p-3 border rounded bg-white">
                                    <option value="">Select Department First</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700">Current CGPA</label>
                                <input type="number" step="0.01" min="0" max="4" id="sCGPA" placeholder="0.00" class="w-full p-3 border rounded" required>
                            </div>
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <select id="sStatus" class="w-full p-3 border rounded bg-white">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Dropout">Dropout</option>
                                </select>
                            </div>
                        </div>
                        <textarea id="sRoutine" placeholder="Admin Notes..." class="w-full p-3 border rounded h-24"></textarea>
                        <button type="submit" id="submit-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded mt-6 shadow-lg">Add/Update Student</button>
                        <div id="admin-message" class="mt-4 text-center hidden p-3 rounded border"></div>
                    </form>
                </div>
            </div>
            
            <div id="routine-panel" class="panel-content hidden">
                <h3 class="text-xl font-semibold mb-4">üóìÔ∏è Publish Routine</h3>
                <form id="routineUploadForm" class="bg-white p-6 rounded shadow">
                    <p class="text-sm text-gray-500 mb-2">Upload a CSV file for the Departmental Routine with columns: [Time, Day, Course, Room].</p>
                    <select id="routineDept" class="w-full p-3 border rounded mb-4"><option value="">Select Dept</option></select>
                    <input type="text" id="routineTitle" placeholder="Routine Title (e.g., Spring 2024)" class="w-full p-3 border rounded mb-4">
                    <input type="file" id="routineFile" accept=".csv" class="w-full p-3 border rounded mb-4">
                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded font-bold hover:bg-purple-700">Upload Routine CSV</button>
                    <div id="routine-message" class="mt-2 hidden"></div>
                </form>
                <div id="published-routines-list" class="mt-6"></div>
            </div>

            <div id="calendar-panel" class="panel-content hidden">
                <h3 class="text-xl font-semibold mb-4">üìÖ Academic Calendar</h3>
                <form id="calendarUploadForm" class="bg-white p-6 rounded shadow mb-4">
                    <p class="text-sm text-gray-500 mb-2">Upload a CSV file with two columns: [Date], [Event].</p>
                    <input type="file" id="calendarFile" accept=".csv" class="w-full p-3 border rounded mb-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700">Upload CSV</button>
                    <div id="calendar-message" class="mt-2 hidden"></div>
                </form>
                <div class="bg-white p-4 rounded shadow overflow-y-auto" style="height: 300px;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100"><th class="p-2 text-left w-1/4">Date</th><th class="p-2 text-left">Event</th></thead>
                        <tbody id="calendar-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="publish-results-panel" class="panel-content hidden">
                <h3 class="text-xl font-semibold mb-4">üìú Publish Results</h3>
                <div class="bg-white p-6 rounded shadow">
                    <input type="text" id="prStudentIdSearch" oninput="debounceLoadResults()" placeholder="Search Student by ID (e.g., CSE03108145)" class="w-full p-3 border rounded mb-4">
                    
                    <select id="prSemester" onchange="loadSemesterResults()" class="w-full p-3 border rounded mb-4"></select>
                    <input type="number" id="prSemesterCGPA" placeholder="Semester CGPA" class="w-full p-3 border rounded mb-4">
                    <div id="pr-results-container" class="mb-4"></div>
                    <button onclick="addPublishResultField()" type="button" class="bg-green-100 text-green-700 px-4 py-2 rounded mb-4 hover:bg-green-200">+ Add Course</button>
                    <button onclick="publishResults()" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Publish</button>
                    <div id="publish-message" class="mt-2 hidden"></div>
                </div>
            </div>
            
            <div id="feedback-panel" class="panel-content hidden">
                <h3 class="text-xl font-semibold mb-4">üåü Student Feedback & Ratings</h3>
                <div class="bg-white p-6 rounded shadow-xl border border-gray-200">
                    <div class="flex items-center justify-between mb-6 pb-4 border-b">
                        <h4 class="text-lg font-semibold text-gray-700">Average System Rating:</h4>
                        <div class="text-5xl font-extrabold text-yellow-600">
                            <span id="average-rating-display">N/A</span> / 5.0
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold mb-3">All Feedback Submissions</h4>
                    <div id="feedback-list-container" class="space-y-4 overflow-y-auto" style="max-height: 400px;">
                        <p id="no-feedback" class="text-gray-500 italic">No feedback submitted yet.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="student-section" class="hidden mt-6" style="display: none;">
            <h2 class="text-3xl font-bold mb-6 text-indigo-700 border-b pb-2">Welcome, <span id="student-name">Student</span>!</h2>
            <div class="flex border-b border-gray-200 mb-6 flex-wrap">
                <button onclick="showStudentTab('s-overview')" class="px-4 py-2 font-medium rounded-t-lg active-tab">Overview</button>
                <button onclick="showStudentTab('s-map'); initMap();" class="px-4 py-2 font-medium rounded-t-lg inactive-tab hover:text-indigo-600">Campus Map</button>
                <button onclick="showStudentTab('s-grading')" class="px-4 py-2 font-medium rounded-t-lg inactive-tab hover:text-indigo-600">Grading Policy</button>
                <button onclick="showStudentTab('s-feedback')" class="px-4 py-2 font-medium rounded-t-lg inactive-tab hover:text-indigo-600">Feedback</button>
                <button onclick="showStudentTab('s-calculator')" class="px-4 py-2 font-medium rounded-t-lg inactive-tab hover:text-indigo-600">CGPA Calculator</button>
            </div>

            <div id="s-overview" class="student-tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-500">
                        <p class="text-gray-500 font-medium">Department</p>
                        <p id="s-dept-display" class="text-xl font-bold text-gray-900 mt-1">N/A</p>
                        <p id="s-program-display" class="text-sm text-gray-400">Major: N/A</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-green-500">
                        <p class="text-gray-500 font-medium">Current CGPA</p>
                        <p id="s-cgpa-display" class="text-3xl font-bold text-green-600 mt-1">N/A</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-purple-500">
                        <p class="text-gray-500 font-medium">Academic Status</p>
                        <p id="s-status-display" class="text-xl font-bold text-indigo-600 mt-1">N/A</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-xl mb-8">
                    <h3 class="text-xl font-semibold mb-4">Academic History</h3>
                    <div id="semester-results-accordion" class="space-y-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded shadow">
                        <h4 class="font-bold mb-2">Class Routine <span id="s-routine-title" class="text-sm text-gray-500"></span></h4>
                        <div id="s-routine-display" class="overflow-x-auto">
                            </div>
                        <p id="s-routine-note" class="text-sm mt-2 italic text-gray-500"></p>
                    </div>
                    <div class="bg-white p-6 rounded shadow overflow-y-auto" style="height: 250px;">
                        <h4 class="font-bold mb-2">Upcoming Events</h4>
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100"><th class="p-2 text-left w-1/3">Date</th><th class="p-2 text-left">Event</th></thead>
                            <tbody id="s-calendar-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="s-map" class="student-tab-content hidden">
                <h3 class="text-xl font-semibold mb-4">üìç Campus Map (PCIU Location)</h3>
                <div class="bg-white p-4 rounded shadow mb-4">
                    <p class="text-gray-600 mb-2">The map shows the university's location. Click below to find your current spot.</p>
                    <button onclick="locateUser()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2">
                        <span>Locate Me</span>
                    </button>
                </div>
                <div id="map" class="shadow-xl border border-gray-300"></div>
            </div>

            <div id="s-grading" class="student-tab-content hidden">
                <h3 class="text-xl font-semibold mb-4">üìê Grading Policy & Formula</h3>
                <div class="bg-white p-8 rounded shadow text-lg leading-relaxed">
                    <p>CGPA Calculation Formula:</p>
                    <div class="my-6 p-6 bg-gray-50 rounded border text-center text-2xl overflow-x-auto">
                        $$ CGPA = \frac{\sum_{i=1}^{n} (C_i \times G_i)}{\sum_{i=1}^{n} C_i} $$
                    </div>
                    <h4 class="font-bold mt-6 mb-2">Grade Point Equivalent (4.0 Scale)</h4>
                    <table class="w-full text-sm border-collapse">
                        <thead class="bg-gray-200"><tr><th class="p-2 border">Grade</th><th class="p-2 border">Grade Point</th></tr></thead>
                        <tbody>
                            <tr><td class="p-2 border">A, A+</td><td class="p-2 border text-center">4.00</td></tr>
                            <tr><td class="p-2 border">A-</td><td class="p-2 border text-center">3.70</td></tr>
                            <tr><td class="p-2 border">B+</td><td class="p-2 border text-center">3.30</td></tr>
                            <tr><td class="p-2 border">B</td><td class="p-2 border text-center">3.00</td></tr>
                            <tr><td class="p-2 border">B-</td><td class="p-2 border text-center">2.70</td></tr>
                            <tr><td class="p-2 border">C+</td><td class="p-2 border text-center">2.30</td></tr>
                            <tr><td class="p-2 border">C</td><td class="p-2 border text-center">2.00</td></tr>
                            <tr><td class="p-2 border">C-</td><td class="p-2 border text-center">1.70</td></tr>
                            <tr><td class="p-2 border">D+</td><td class="p-2 border text-center">1.30</td></tr>
                            <tr><td class="p-2 border">D</td><td class="p-2 border text-center">1.00</td></tr>
                            <tr><td class="p-2 border">F</td><td class="p-2 border text-center">0.00</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="s-feedback" class="student-tab-content hidden">
                <h3 class="text-xl font-semibold mb-4">‚≠ê Student Feedback</h3>
                <div class="bg-white p-6 rounded shadow max-w-lg">
                    <p class="mb-4 text-gray-600">Your anonymous feedback helps us improve the portal and university services.</p>
                    <form id="feedbackForm" onsubmit="submitFeedback(event)">
                        <label class="block mb-2 font-medium">Rate your experience:</label>
                        <div class="flex gap-4 mb-4 text-3xl cursor-pointer select-none">
                            <span onclick="setRating(1)" class="transition-all hover:scale-125">üò°</span>
                            <span onclick="setRating(2)" class="transition-all hover:scale-125">üôÅ</span>
                            <span onclick="setRating(3)" class="transition-all hover:scale-125">üòê</span>
                            <span onclick="setRating(4)" class="transition-all hover:scale-125">üôÇ</span>
                            <span onclick="setRating(5)" class="transition-all hover:scale-125">üòç</span>
                        </div>
                        <input type="hidden" id="ratingValue" value="5">
                        <textarea id="feedbackMessage" class="w-full p-3 border rounded mb-4 focus:ring-indigo-500" placeholder="Suggestions or comments..." rows="4"></textarea>
                        <button class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 transition">Submit Feedback</button>
                    </form>
                </div>
            </div>
            
            <div id="s-calculator" class="student-tab-content hidden">
                <h3 class="text-xl font-semibold mb-4">üßÆ CGPA Calculator (Scale 4.0)</h3>
                <div class="bg-white p-6 rounded shadow max-w-xl mx-auto">
                    <div id="course-input-container" class="space-y-4 mb-6">
                        </div>
                    
                    <button onclick="addCourseField()" type="button" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded mb-4 hover:bg-indigo-200 font-medium">+ Add Course</button>
                    
                    <button onclick="calculateCGPA()" type="button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded mt-2 shadow-md">
                        Calculate CGPA
                    </button>

                    <div class="mt-6 p-4 border border-gray-300 rounded bg-gray-50 text-center">
                        <p class="text-lg font-medium text-gray-700">Calculated CGPA:</p>
                        <p id="calculated-cgpa" class="text-4xl font-extrabold text-green-600 mt-1">0.00</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="delete-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center opacity-0 pointer-events-none z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform transition-all scale-95">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirm Deletion</h3>
            <p class="text-gray-700 mb-6">Permanently delete this student?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // üö® CONFIG üö®
        const firebaseConfig = {
            apiKey: "AIzaSyCNgK0n2OxTggtZcu0hraTWhMhtLW0oxmc",
            authDomain: "studentinfo-fd67b.firebaseapp.com",
            projectId: "studentinfo-fd67b",
            storageBucket: "studentinfo-fd67b.firebasestorage.app",
            messagingSenderId: "1023011026315",
            appId: "1:1023011026315:web:455120a62b7a3c80e86b8e"
        };

        window.onerror = function(message) {
             if (message.includes("firebase") || message.includes("Tailwind")) {
                 console.error("Network Error: Libraries failed to load. Please check connection.");
             }
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const ADMIN_EMAIL = 'admin@university.edu';
        
       // --- MAP COORDINATES (PCIU - Nikunja Housing Society, Chattogram) ---
        const PCIU_LAT = 22.2134; 
        const PCIU_LON = 91.4835;

        // --- GLOBAL STATE ---
        let allStudentDocs = [];
        let filteredDocs = [];
        let currentPage = 1;
        const itemsPerPage = 5; 
        let mapInitialized = false;
        let map;

        // --- ANIMATION & UI UTILS ---
        function animatePanel(id) {
            if (typeof gsap !== 'undefined') gsap.fromTo(`#${id}`, {opacity: 0, y: 20}, {opacity: 1, y: 0, duration: 0.4, ease: "power2.out"});
        }

        function showSection(id) {
            ['login-section', 'admin-section', 'student-section'].forEach(s => {
                const el = document.getElementById(s);
                el.classList.add('hidden');
                el.style.display = 'none'; 
            });
            
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.classList.add('hidden');
            logoutBtn.style.display = 'none';
            
            if(id) {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                el.style.display = 'block'; 
                animatePanel(id);
                if(id !== 'login-section') {
                    logoutBtn.classList.remove('hidden');
                    logoutBtn.style.display = 'block';
                }
            }
        }

        function showAdminPanel(panelId) {
            document.querySelectorAll('.panel-content').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active-tab');
                b.classList.add('inactive-tab');
            });
            
            const activePanel = document.getElementById(panelId);
            activePanel.classList.remove('hidden');
            animatePanel(panelId);

            const tabId = panelId.replace('-panel', '-tab');
            const activeTab = document.getElementById(tabId);
            activeTab.classList.add('active-tab');
            activeTab.classList.remove('inactive-tab');

            if (panelId === 'dashboard-panel') fetchDashboardData();
            if (panelId === 'routine-panel') populateRoutineDropdowns();
            if (panelId === 'publish-results-panel') initPublishResults();
            if (panelId === 'feedback-panel') fetchFeedback(); // Fetch feedback for the new panel
        }

        function showStudentTab(tabId) {
            document.querySelectorAll('.student-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            animatePanel(tabId);
            
            if (tabId === 's-map' && map) setTimeout(() => map.invalidateSize(), 100);
            
            // Initialization for CGPA Calculator
            if (tabId === 's-calculator') {
                 const container = document.getElementById('course-input-container');
                 if (container && container.children.length === 0) {
                    addCourseField(); 
                 }
                 calculateCGPA(); 
            }
        }

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                if (user.email === ADMIN_EMAIL) {
                    showSection('admin-section');
                    showAdminPanel('dashboard-panel');
                } else {
                    fetchStudentProfile(user.email);
                }
            } else {
                showSection('login-section');
            }
        });

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (e) {
                const err = document.getElementById('login-error');
                err.textContent = e.message;
                err.classList.remove('hidden');
            }
        }

        function logout() { auth.signOut(); window.location.reload(); }

        // --- DASHBOARD & PAGINATION ---
        async function fetchDashboardData() {
            const snap = await db.collection("students").get();
            allStudentDocs = snap.docs;
            filteredDocs = allStudentDocs;
            
            let active = 0, dropout = 0;
            const departments = new Set();
            
            allStudentDocs.forEach(doc => {
                const d = doc.data();
                if(d.status === 'Active') active++; else dropout++;
                if(d.department) departments.add(d.department);
            });
            
            document.getElementById('dashboard-total-students').textContent = allStudentDocs.length;
            document.getElementById('dashboard-active-enrollment').textContent = active;
            document.getElementById('dashboard-inactive-dropout').textContent = dropout;
            document.getElementById('dashboard-department-count').textContent = departments.size;

            populateDeptFilter();
            renderTablePage(1);
        }

        function renderTablePage(page) {
            currentPage = page;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageDocs = filteredDocs.slice(start, end);
            
            const tbody = document.getElementById('student-list-body');
            tbody.innerHTML = '';
            
            if(pageDocs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No data found</td></tr>';
                return;
            }

            pageDocs.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement('tr');
                tr.className = 'academic-row border-b border-gray-100 transition';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${data.name}</td>
                    <td class="px-6 py-4 text-gray-500">${data.studentId}</td>
                    <td class="px-6 py-4 text-xs text-gray-500">
                        <div>üìû ${data.phone || 'N/A'}</div>
                        <div>üìß ${data.email}</div>
                    </td>
                    <td class="px-6 py-4 font-bold ${data.cgpa >= 3.0 ? 'text-green-600' : 'text-orange-500'}">${(data.cgpa || 0).toFixed(2)}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${data.status==='Active'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${data.status}</span></td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="editStudent('${data.email}')" class="text-indigo-600 hover:underline mr-2">Edit</button>
                        <button onclick="confirmDelete('${data.email}')" class="text-red-600 hover:underline">Del</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('page-info-start').textContent = filteredDocs.length > 0 ? start + 1 : 0;
            document.getElementById('page-info-end').textContent = Math.min(end, filteredDocs.length);
            document.getElementById('page-info-total').textContent = filteredDocs.length;
            
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = end >= filteredDocs.length;
        }

        function prevPage() { if(currentPage > 1) renderTablePage(currentPage - 1); }
        function nextPage() { if((currentPage * itemsPerPage) < filteredDocs.length) renderTablePage(currentPage + 1); }

        function populateDeptFilter() {
            const depts = new Set(allStudentDocs.map(d => d.data().department).filter(Boolean));
            const sel = document.getElementById('department-filter');
            sel.innerHTML = '<option value="All">All Departments</option>';
            depts.forEach(d => sel.add(new Option(d, d)));
        }

        function filterByDepartment() {
            const val = document.getElementById('department-filter').value;
            filteredDocs = val === 'All' ? allStudentDocs : allStudentDocs.filter(d => d.data().department === val);
            renderTablePage(1);
        }

        function searchStudents() {
            const term = document.getElementById('search-input').value.toLowerCase();
            filteredDocs = allStudentDocs.filter(d => {
                const data = d.data();
                return (data.name && data.name.toLowerCase().includes(term)) ||
                       (data.studentId && data.studentId.toLowerCase().includes(term)) ||
                       (data.phone && data.phone.includes(term));
            });
            renderTablePage(1);
        }

        // --- ADD/EDIT LOGIC ---
        function updatePrograms() {
            const dept = document.getElementById('sDept').value;
            const progSel = document.getElementById('sProgram');
            progSel.innerHTML = '';
            let options = [];
            if(dept === 'Computer Science') options = ['B.Sc CSE', 'B.Sc SE', 'M.Sc CS'];
            else if(dept === 'Business Admin') options = ['BBA', 'MBA', 'Economics'];
            else if(dept === 'Electrical Eng') options = ['B.Sc EEE', 'B.Sc ETE'];
            else if(dept === 'LLB') options = ['LLB (Honors)'];
            else if(dept === 'CEN') options = ['B.Sc CE', 'M.Sc CE'];
            else if(dept === 'ENG') options = ['B.A English', 'M.A English'];
            else options = ['Select Department First'];
            options.forEach(o => progSel.add(new Option(o, o)));
        }

        function checkUniqueId(id) {
            const exists = allStudentDocs.some(d => d.data().studentId === id && d.data().email !== document.getElementById('originalEmail').value);
            const err = document.getElementById('id-error');
            if(exists) {
                err.classList.remove('hidden');
                document.getElementById('submit-button').disabled = true;
            } else {
                err.classList.add('hidden');
                document.getElementById('submit-button').disabled = false;
            }
            autoFillPassword();
        }

        function validatePhone(input) {
            const regex = /^(\+880|0)1[3-9]\d{8}$/; 
            const err = document.getElementById('phone-error');
            if(!regex.test(input.value.replace(/[-\s]/g, ''))) err.classList.remove('hidden');
            else err.classList.add('hidden');
        }

        function autoFillPassword() {
            const isNew = !document.getElementById('originalEmail').value;
            if(isNew) document.getElementById('sPassword').value = document.getElementById('sID').value;
        }

        function resetForm() {
            document.getElementById('addStudentForm').reset();
            document.getElementById('originalEmail').value = '';
            document.getElementById('form-title').textContent = 'Add Student Data';
            document.getElementById('sEmail').readOnly = false;
            document.getElementById('submit-button').textContent = 'Add Student';
        }

        async function editStudent(email) {
            showAdminPanel('add-student-panel');
            const doc = allStudentDocs.find(d => d.id === email);
            if(!doc) return;
            const data = doc.data();

            document.getElementById('form-title').textContent = 'Edit: ' + data.name;
            document.getElementById('submit-button').textContent = 'Update Student';
            document.getElementById('originalEmail').value = email;
            
            document.getElementById('sID').value = data.studentId;
            document.getElementById('sName').value = data.name;
            document.getElementById('sEmail').value = data.email;
            document.getElementById('sEmail').readOnly = true;
            document.getElementById('sPhone').value = data.phone || '';
            document.getElementById('sDOB').value = data.dob || '';
            document.getElementById('sDept').value = data.department;
            updatePrograms(); 
            document.getElementById('sProgram').value = data.program || '';
            document.getElementById('sCGPA').value = data.cgpa;
            document.getElementById('sStatus').value = data.status;
            document.getElementById('sRoutine').value = data.routine || '';
        }

        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalEmail = document.getElementById('originalEmail').value;
            const email = document.getElementById('sEmail').value;
            const pass = document.getElementById('sPassword').value;
            const msg = document.getElementById('admin-message');

            const payload = {
                studentId: document.getElementById('sID').value,
                name: document.getElementById('sName').value,
                email: email,
                phone: document.getElementById('sPhone').value,
                dob: document.getElementById('sDOB').value,
                department: document.getElementById('sDept').value,
                program: document.getElementById('sProgram').value,
                cgpa: parseFloat(document.getElementById('sCGPA').value),
                status: document.getElementById('sStatus').value,
                routine: document.getElementById('sRoutine').value
            };

            try {
                if(!originalEmail) {
                    await auth.createUserWithEmailAndPassword(email, pass);
                    // Note: In a real app, you'd use cloud functions to sync data and auth. 
                    // For this simple environment, we proceed with data update/creation.
                }
                await db.collection("students").doc(email).set(payload, {merge: true});
                
                msg.textContent = originalEmail ? "Student data updated successfully!" : "Student added and login created.";
                msg.className = "mt-4 text-center p-3 rounded border bg-green-100 text-green-700";
                msg.classList.remove('hidden');
                fetchDashboardData();
                if(!originalEmail) resetForm(); 

            } catch(err) {
                msg.textContent = err.message;
                msg.className = "mt-4 text-center p-3 rounded border bg-red-100 text-red-700";
                msg.classList.remove('hidden');
            }
        });

        // --- DELETE STUDENT ---
        let pendingDeleteEmail = null;
        function confirmDelete(email) {
            pendingDeleteEmail = email;
            const m = document.getElementById('delete-modal');
            m.classList.remove('opacity-0', 'pointer-events-none');
            m.querySelector('.transform').classList.remove('scale-95');
            m.querySelector('.transform').classList.add('scale-100');
            
            document.getElementById('confirm-delete-btn').onclick = async () => {
                await db.collection("students").doc(pendingDeleteEmail).delete();
                closeModal();
                fetchDashboardData();
            };
        }
        function closeModal() {
            const m = document.getElementById('delete-modal');
            m.classList.add('opacity-0', 'pointer-events-none');
            m.querySelector('.transform').classList.add('scale-95');
            m.querySelector('.transform').classList.remove('scale-100');
        }

        // --- STUDENT PORTAL LOGIC ---
        async function fetchStudentProfile(email) {
            try {
                const doc = await db.collection("students").doc(email).get();
                if(!doc.exists) throw new Error("Profile not found.");
                
                const data = doc.data();
                showSection('student-section');
                showStudentTab('s-overview');
                
                document.getElementById('student-name').textContent = data.name;
                document.getElementById('s-dept-display').textContent = data.department;
                document.getElementById('s-program-display').textContent = data.program || 'N/A';
                document.getElementById('s-cgpa-display').textContent = (data.cgpa || 0).toFixed(2);
                document.getElementById('s-status-display').textContent = data.status;
                // document.getElementById('s-routine-display').textContent = data.routine || 'No notes.'; // Original note field
                document.getElementById('s-routine-note').textContent = data.routine || ''; // Keeping the admin note field separate
                
                // NEW: Fetch and render departmental routine
                if (data.department) {
                    await fetchDepartmentRoutine(data.department);
                } else {
                    document.getElementById('s-routine-display').innerHTML = '<p class="text-gray-500 italic">Department not specified for routine.</p>';
                    document.getElementById('s-routine-title').textContent = '';
                }

                renderHistory(data.semesters);
                fetchAcademicCalendar(true); 
                if(typeof MathJax !== 'undefined') MathJax.typesetPromise();

            } catch(e) {
                console.error(e.message);
                // alert(e.message); // Commented out to prevent blocking alert in prod
                // auth.signOut(); // Keep user logged in if error is minor
            }
        }

        // NEW: Function to fetch and display routine for a department
        async function fetchDepartmentRoutine(department) {
            const c = document.getElementById('s-routine-display');
            const titleEl = document.getElementById('s-routine-title');
            c.innerHTML = '<p class="text-gray-500 italic">Loading routine...</p>';
            titleEl.textContent = '';
            
            try {
                const doc = await db.collection("routines").doc(department).get();
                if (doc.exists && doc.data().schedule) {
                    const data = doc.data();
                    titleEl.textContent = data.title ? `(${data.title})` : '';
                    
                    // Render routine table
                    c.innerHTML = `
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">Time</th>
                                    <th class="p-2 text-left">Day</th>
                                    <th class="p-2 text-left">Course</th>
                                    <th class="p-2 text-left">Room</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${data.schedule.map(r => `
                                    <tr>
                                        <td class="p-2">${r.time}</td>
                                        <td class="p-2">${r.day}</td>
                                        <td class="p-2">${r.course}</td>
                                        <td class="p-2">${r.room}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    c.innerHTML = '<p class="text-gray-500 italic">No departmental routine published yet.</p>';
                }
            } catch (error) {
                console.error("Error fetching routine:", error);
                c.innerHTML = '<p class="text-red-500 italic">Failed to load routine.</p>';
            }
        }


        function renderHistory(sems) {
            const c = document.getElementById('semester-results-accordion');
            c.innerHTML = '';
            if(!sems) { c.innerHTML = '<p class="text-gray-500 italic">No results published yet.</p>'; return; }
            
            for(let i=1; i<=8; i++) {
                const key = `sem${i}`;
                if(sems[key] && sems[key].results) {
                    const s = sems[key];
                    c.innerHTML += `
                        <div class="accordion-item border rounded mb-2 overflow-hidden">
                            <button onclick="this.parentElement.classList.toggle('active')" class="w-full flex justify-between p-4 bg-gray-50 font-semibold text-left">
                                <span>Semester ${i} (CGPA: ${s.cgpa})</span>
                                <span class="accordion-button">‚ñ∂</span>
                            </button>
                            <div class="accordion-content bg-white p-4">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-100"><th class="p-2 text-left">Course</th><th class="p-2">Grade</th><th class="p-2">Mark</th></tr></thead>
                                    <tbody>
                                        ${s.results.map(r => `<tr><td class="p-2 border-b">${r.course}</td><td class="p-2 border-b text-center font-bold">${r.grade}</td><td class="p-2 border-b text-center">${r.marks}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // --- MAPS (Change 2: Fixed PCIU Location) ---
        function initMap() {
            if(mapInitialized && map) {
                map.setView([PCIU_LAT, PCIU_LON], 15); // Reset to default view
                map.invalidateSize();
                return;
            }
            
            // Initialize map to fixed PCIU location
            map = L.map('map').setView([PCIU_LAT, PCIU_LON], 15); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                attribution: '&copy; OpenStreetMap contributors' 
            }).addTo(map);

            // Add a permanent marker for the University
            L.marker([PCIU_LAT, PCIU_LON]).addTo(map).bindPopup('Port City International University, Nijunja Housing Society').openPopup();
            
            mapInitialized = true;
        }

        // New function to handle geolocation ONLY when button is clicked
        function locateUser() {
             if (!mapInitialized) initMap(); // Ensure map is initialized
             
             // Remove old markers before adding new one
             map.eachLayer(layer => {
                if (layer instanceof L.Marker && layer.getLatLng().lat !== PCIU_LAT && layer.getLatLng().lng !== PCIU_LON) {
                    map.removeLayer(layer);
                }
             });
             
             if (navigator.geolocation) {
                // Use a custom alert/message box instead of the blocking alert()
                console.log("Attempting to find user's current location...");
                
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    map.setView([lat, lon], 15);
                    L.marker([lat, lon]).addTo(map).bindPopup('You are here!').openPopup();
                    L.circle([lat, lon], {color: 'blue', fillColor: '#30f', fillOpacity: 0.1, radius: 200}).addTo(map);
                }, () => { 
                    console.error("Geolocation failed or denied.");
                    map.setView([PCIU_LAT, PCIU_LON], 15);
                });
            } else {
                 console.error("Geolocation is not supported by your browser.");
            }
        }

        // --- FEEDBACK (Change 3: Submission) ---
        function setRating(n) { document.getElementById('ratingValue').value = n; }
        
        async function submitFeedback(e) {
            e.preventDefault(); 
            const rating = document.getElementById('ratingValue').value;
            const message = document.getElementById('feedbackMessage').value;
            const user = auth.currentUser;
            
            if (!user || !user.email) {
                console.error("User not logged in or email unavailable for feedback.");
                return;
            }

            try {
                await db.collection("feedback").add({
                    userEmail: user.email,
                    rating: parseInt(rating),
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                // Simple confirmation without alert()
                e.target.innerHTML = '<p class="text-green-600 font-bold">Thank you for your feedback! It has been submitted.</p>';
            } catch(e) {
                console.error("Error submitting feedback: " + e.message);
                e.target.innerHTML = `<p class="text-red-600 font-bold">Error submitting feedback: ${e.message}</p>`;
            }
        }

        // --- ADMIN FEEDBACK VIEW (Change 3: Fetching) ---
        async function fetchFeedback() {
            const container = document.getElementById('feedback-list-container');
            const avgDisplay = document.getElementById('average-rating-display');
            const noFeedback = document.getElementById('no-feedback');
            container.innerHTML = '';
            avgDisplay.textContent = '...';
            noFeedback.classList.add('hidden');

            try {
                const snapshot = await db.collection("feedback").orderBy("timestamp", "desc").get();
                let totalRating = 0;
                let count = 0;
                
                if (snapshot.empty) {
                    avgDisplay.textContent = 'N/A';
                    noFeedback.classList.remove('hidden');
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const rating = data.rating || 0;
                    totalRating += rating;
                    count++;
                    
                    const time = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    const item = document.createElement('div');
                    item.className = "p-3 bg-gray-50 border border-gray-200 rounded-lg";
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-indigo-600">${data.userEmail}</span>
                            <span class="text-xl text-yellow-500">
                                ${'‚òÖ'.repeat(rating)}${'‚òÜ'.repeat(5 - rating)}
                            </span>
                        </div>
                        <p class="text-sm text-gray-700 italic">"${data.message || 'No comment provided'}"</p>
                        <p class="text-xs text-gray-400 mt-2">Submitted on: ${time}</p>
                    `;
                    container.appendChild(item);
                });

                const average = count > 0 ? (totalRating / count).toFixed(1) : '0.0';
                avgDisplay.textContent = average;

            } catch (error) {
                console.error("Error fetching feedback:", error);
                avgDisplay.textContent = 'Error';
                container.innerHTML = `<p class="text-red-500">Failed to load feedback: ${error.message}</p>`;
            }
        }


        // --- CGPA CALCULATOR LOGIC ---
        const GRADE_POINTS = {
                       'A+': 4.00, 'A': 4.00, 'A-': 3.70,
            'B+': 3.30, 'B': 3.00, 'B-': 2.70,
            'C+': 2.30, 'C': 2.00, 'C-': 1.70,
            'D+': 1.30, 'D': 1.00,
            'F': 0.00, 'W': 0.00, 'I': 0.00,
            'S': 0.00, 'U': 0.00 
        };

        function addCourseField() {
            const container = document.getElementById('course-input-container');
            const div = document.createElement('div');
            div.className = "flex gap-2 course-entry";
            
            const gradeOptions = Object.keys(GRADE_POINTS).map(grade => `<option value="${grade}">${grade}</option>`).join('');

            div.innerHTML = `
                <input placeholder="Credit" type="number" step="0.5" min="0.5" value="3.0" class="credit-input border p-2 w-1/4 rounded" oninput="calculateCGPA()">
                <select class="grade-select border p-2 w-1/4 rounded bg-white" onchange="calculateCGPA()">
                    <option value="" disabled selected>Grade</option>
                    ${gradeOptions}
                </select>
                <div class="w-1/2 flex items-center gap-2">
                    <input placeholder="Course Name" class="course-name-input border p-2 flex-grow rounded">
                    <button type="button" onclick="this.closest('.course-entry').remove(); calculateCGPA();" class="text-red-500 font-bold p-2 text-xl hover:bg-red-50 rounded-full leading-none">√ó</button>
                </div>
            `;
            container.appendChild(div);
             if (container.children.length < 3) { 
                addCourseField(); 
            }
        }

        function calculateCGPA() {
            const entries = document.querySelectorAll('.course-entry');
            let totalQualityPoints = 0;
            let totalCreditsAttempted = 0;

            entries.forEach(e => {
                const creditInput = e.querySelector('.credit-input');
                const gradeSelect = e.querySelector('.grade-select');
                
                const credits = parseFloat(creditInput.value);
                const grade = gradeSelect.value;

                if (credits > 0 && GRADE_POINTS.hasOwnProperty(grade)) {
                    const gradePoint = GRADE_POINTS[grade];
                    
                    if (gradePoint > 0.00) {
                        totalQualityPoints += credits * gradePoint;
                        totalCreditsAttempted += credits;
                    }
                }
            });

            let cgpa = 0.00;
            if (totalCreditsAttempted > 0) {
                cgpa = totalQualityPoints / totalCreditsAttempted;
            }

            document.getElementById('calculated-cgpa').textContent = cgpa.toFixed(2);
        }

        // --- ADMIN UTILS (Calendar & Results) ---
        
        // Change 1: CSV Upload Logic for Calendar
        document.getElementById('calendarUploadForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('calendarFile').files[0];
            const msg = document.getElementById('calendar-message');
            msg.classList.add('hidden');
            
            if (!file) {
                msg.textContent = 'Please select a CSV file.';
                msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                msg.classList.remove('hidden');
                return;
            }

            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: async function(results) {
                    const calendarData = results.data
                        .filter(row => row.length >= 2) 
                        .map(row => ({ date: row[0].trim(), event: row[1].trim() }));

                    if (calendarData.length === 0) {
                         msg.textContent = 'CSV is empty or incorrectly formatted.';
                         msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                         msg.classList.remove('hidden');
                         return;
                    }

                    try {
                        await db.collection("utility").doc("academicCalendar").set({ calendar: calendarData });
                        msg.textContent = `Successfully uploaded ${calendarData.length} events.`;
                        msg.className = "mt-2 p-2 bg-green-100 text-green-700 rounded border border-green-300";
                        msg.classList.remove('hidden');
                        fetchAcademicCalendar(false); 
                    } catch (error) {
                        msg.textContent = 'Error saving to database: ' + error.message;
                        msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                        msg.classList.remove('hidden');
                    }
                },
                error: function(error) {
                    msg.textContent = 'Error parsing CSV: ' + error.message;
                    msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                    msg.classList.remove('hidden');
                }
            });
        });
        
        function fetchAcademicCalendar(isStudent = false) {
            const id = isStudent ? 's-calendar-table-body' : 'calendar-table-body';
            const tb = document.getElementById(id);
            if(tb) tb.innerHTML = '<tr><td colspan="2">Loading...</td></tr>';
            
            db.collection("utility").doc("academicCalendar").get().then(d => {
                if(tb) {
                    if(d.exists && d.data().calendar) {
                        // Ensure two columns are rendered for both Admin and Student panels
                        tb.innerHTML = d.data().calendar.map(e => `<tr><td class="p-2 font-bold w-1/3">${e.date}</td><td class="p-2">${e.event}</td></tr>`).join('');
                    } else {
                        tb.innerHTML = '<tr><td class="p-2" colspan="2">No events found.</td></tr>';
                    }
                }
            });
        }

        // NEW: Routine Upload Logic (Similar to Calendar)
        document.getElementById('routineUploadForm').addEventListener('submit', handleRoutineUpload);

        async function handleRoutineUpload(e) {
            e.preventDefault();
            const dept = document.getElementById('routineDept').value;
            const title = document.getElementById('routineTitle').value.trim();
            const file = document.getElementById('routineFile').files[0];
            const msg = document.getElementById('routine-message');
            msg.classList.add('hidden');

            if (!dept || !file) {
                msg.textContent = 'Please select a Department and a CSV file.';
                msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                msg.classList.remove('hidden');
                return;
            }

            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: async function(results) {
                    // Expected CSV columns: [Time, Day, Course, Room]
                    const routineData = results.data
                        .filter(row => row.length >= 4) 
                        .map(row => ({ time: row[0].trim(), day: row[1].trim(), course: row[2].trim(), room: row[3].trim() }));

                    if (routineData.length === 0) {
                         msg.textContent = 'CSV is empty or incorrectly formatted. Expected columns: Time, Day, Course, Room.';
                         msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                         msg.classList.remove('hidden');
                         return;
                    }

                    try {
                        // Store routine in 'routines' collection, with department name as the document ID
                        await db.collection("routines").doc(dept).set({ 
                            title: title,
                            schedule: routineData,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        msg.textContent = `Successfully uploaded routine for ${dept} (${routineData.length} entries).`;
                        msg.className = "mt-2 p-2 bg-green-100 text-green-700 rounded border border-green-300";
                        msg.classList.remove('hidden');
                    } catch (error) {
                        msg.textContent = 'Error saving to database: ' + error.message;
                        msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                        msg.classList.remove('hidden');
                    }
                },
                error: function(error) {
                    msg.textContent = 'Error parsing CSV: ' + error.message;
                    msg.className = "mt-2 p-2 bg-red-100 text-red-700 rounded border border-red-300";
                    msg.classList.remove('hidden');
                }
            });
        }
        
        // Update populateRoutineDropdowns to use unique departments from student data
        function populateRoutineDropdowns() {
             const d = document.getElementById('routineDept');
             d.innerHTML = '<option value="">Select Dept</option>';
             // Map and filter for unique, non-empty department names
             new Set(allStudentDocs.map(x=>x.data().department).filter(Boolean)).forEach(x => d.add(new Option(x,x)));
        }
        
        let searchTimeout;
        function debounceLoadResults() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadSemesterResults();
            }, 500); 
        }

        function initPublishResults() {
            const selSem = document.getElementById('prSemester');
            selSem.innerHTML = '';
            for(let i=1; i<=8; i++) selSem.add(new Option(`Semester ${i}`, i));
            document.getElementById('pr-results-container').innerHTML = '';
            document.getElementById('prSemesterCGPA').value = '';
        }

        async function loadSemesterResults() {
            const studentId = document.getElementById('prStudentIdSearch').value.trim();
            const sem = document.getElementById('prSemester').value;
            const container = document.getElementById('pr-results-container');
            container.innerHTML = '';
            document.getElementById('prSemesterCGPA').value = '';

            if(!studentId) return;

            const studentDoc = allStudentDocs.find(d => d.data().studentId === studentId);

            if (!studentDoc) {
                container.innerHTML = `<p class="text-red-500">Student ID ${studentId} not found.</p>`;
                return;
            }
            
            const data = studentDoc.data();
            const sData = data.semesters ? data.semesters[`sem${sem}`] : null;

            if(sData) {
                document.getElementById('prSemesterCGPA').value = sData.cgpa;
                sData.results.forEach(r => addPublishResultField(r.course, r.grade, r.marks));
            } else {
                addPublishResultField(); 
            }
        }

        function addPublishResultField(c='', g='', m='') {
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2 result-entry";
            div.innerHTML = `
                <input placeholder="Course" value="${c}" class="border p-2 w-1/3 rounded">
                <input placeholder="Grade" value="${g}" class="border p-2 w-1/4 rounded">
                <input placeholder="Mark" value="${m}" type="number" class="border p-2 w-1/4 rounded">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 font-bold px-2">x</button>
            `;
            document.getElementById('pr-results-container').appendChild(div);
        }

        async function publishResults() {
            const studentId = document.getElementById('prStudentIdSearch').value.trim();
            const sem = document.getElementById('prSemester').value;
            const cgpa = parseFloat(document.getElementById('prSemesterCGPA').value);
            const msg = document.getElementById('publish-message');

            const studentDoc = allStudentDocs.find(d => d.data().studentId === studentId);
            if (!studentDoc) {
                msg.textContent = `Error: Student ID ${studentId} not found.`;
                msg.className = "mt-4 text-center p-3 rounded border bg-red-100 text-red-700";
                msg.classList.remove('hidden');
                return;
            }
            const email = studentDoc.id;

            const entries = document.querySelectorAll('.result-entry');
            const results = Array.from(entries).map(e => {
                const i = e.querySelectorAll('input');
                return { course: i[0].value, grade: i[1].value, marks: i[2].value };
            });

            try {
                const key = `semesters.sem${sem}`;
                await db.collection("students").doc(email).update({ [key]: { cgpa, results } });
                msg.textContent = "Results Published!";
                msg.className = "mt-4 text-center p-3 rounded border bg-green-100 text-green-700";
                msg.classList.remove('hidden');
            } catch (err) {
                msg.textContent = err.message;
                msg.className = "mt-4 text-center p-3 rounded border bg-red-100 text-red-700";
                msg.classList.remove('hidden');
            }
        }
        
        // document.getElementById('routineUploadForm').addEventListener('submit', async (e) => { e.preventDefault(); console.log("Routine upload logic triggered."); }); // Removed empty function
    </script>
</body>
</html>
